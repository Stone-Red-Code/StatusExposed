@page "/check"

@using System.Text.RegularExpressions
@using StatusExposed.Services

@inject NavigationManager NavigationManger
@inject IStatusService StatusService

<div class="control-section centerArea">
    <div class="text-center">

        <Validations StatusChanged="ValidationStatusChanged">
            <Validation Validator="ValidateDomain">
                <Field>
                    <FieldLabel>Website domain</FieldLabel>
                    <TextEdit Placeholder="example.com" @bind-Text="domainText" KeyDown="Enter">
                        <Feedback>
                            <ValidationNone>Enter a domain.</ValidationNone>
                            <ValidationSuccess>Domain is valid.</ValidationSuccess>
                            <ValidationError>Enter a valid domain!</ValidationError>
                        </Feedback>
                    </TextEdit>
                </Field>
            </Validation>
            <Button Color="Color.Primary" Clicked="@Submit" Disabled="!isValid || isLoading" Loading="@isLoading">Check</Button>
        </Validations>
    </div>
</div>

@code {
    [Parameter]
    public string? AutoFillDomain { get; set; }

    private bool isValid;
    private bool isLoading;

    private string? domainText;

    protected override void OnParametersSet()
    {
        domainText = AutoFillDomain?.Replace('/', '.');
    }

    private void Submit()
    {
        if (domainText is null || !isValid)
        {
            return;
        }

        isLoading = true;
        NavigationManger.NavigateTo($"/{domainText.Replace('.', '/')}");
    }

    private void ValidationStatusChanged(ValidationsStatusChangedEventArgs e)
    {
        isValid = e.Status != ValidationStatus.Error;
    }

    private void ValidateDomain(ValidatorEventArgs e)
    {
        string? domain = e.Value?.ToString();

        if (string.IsNullOrEmpty(domain))
        {
            e.Status = ValidationStatus.Error;
            return;
        }

        if (Regex.IsMatch(domain, @"(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\.)+[a-z0-9][a-z0-9-]{0,61}[a-z0-9]"))
        {
            e.Status = ValidationStatus.Success;
            return;
        }

        e.Status = ValidationStatus.Error;
    }

    public void Enter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            Submit();
        }
    }
}
