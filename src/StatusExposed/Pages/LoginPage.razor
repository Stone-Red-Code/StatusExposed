@page "/login/{*MailToken}"

@using System.Text.RegularExpressions

@using StatusExposed.Services

@inject IAuthenticationService AuthenticationService

@inject NavigationManager NavigationManager

<div class="control-section centerArea">
    <div class="text-center">
        @if (string.IsNullOrWhiteSpace(MailToken))
        {
            <Validations StatusChanged="ValidationStatusChanged">
                <Validation Validator="ValidationRule.IsEmail">
                    <Field>
                        <FieldLabel>Your E-Mail</FieldLabel>
                        <TextEdit Placeholder="example@example.com" @bind-Text="email" Disabled="isLoading" KeyDown="Enter" Autofocus="true">
                            <Feedback>
                                <ValidationNone>Enter your E-Mail.</ValidationNone>
                                <ValidationSuccess>E-Mail is valid.</ValidationSuccess>
                                <ValidationError>Enter a valid E-Mail!</ValidationError>
                            </Feedback>
                        </TextEdit>
                    </Field>
                </Validation>
                <Button Color="Color.Primary" Clicked="@Submit" Disabled="!isValid || isLoading" Loading="@isLoading">Log In/Create Account</Button>
            </Validations>
        }

        <p class="mt-3"><strong>@infoText</strong></p>
    </div>
</div>

@code {
    [Parameter]
    public string? MailToken { get; set; }

    private bool isValid;
    private bool isLoading;

    private string? email;

    private string? infoText;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!string.IsNullOrWhiteSpace(MailToken) && firstRender)
        {
            bool success = await AuthenticationService.VerifyUserAsync(MailToken);

            if (!success)
            {
                infoText = "Login token is not valid!";
                MailToken = null;
                StateHasChanged();
            }
            else
            {
                NavigationManager.NavigateTo("/account", true);
            }
        }
        else if (await AuthenticationService.IsAuthenticated())
        {
            NavigationManager.NavigateTo("/account", true);
        }
    }

    private async Task Submit()
    {
        if (email is null || !isValid || isLoading)
        {
            return;
        }

        isLoading = true;
        infoText = "Processing information...";
        StateHasChanged();

        if (await AuthenticationService.UserExistsAsync(email))
        {
            if(!await AuthenticationService.LoginUserAsync(email))
            {
                infoText = "Account has been banned!";
                isLoading = false;
                return;
            }
        }
        else
        {
            await AuthenticationService.RegisterUserAsync(email);
        }

        infoText = "We have sent you a verification E-Mail.";
    }

    private void ValidationStatusChanged(ValidationsStatusChangedEventArgs e)
    {
        isValid = e.Status != ValidationStatus.Error;
    }

    public async Task Enter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await Submit();
        }
    }
}
